// ---------- Code.gs ----------
// Web App: Admission Fee Receipt Generator
// Make sure your sheet is named "Admissions"
const TEMPLATE_DOC_ID = "PASTE_YOUR_TEMPLATE_DOC_ID_HERE"; // <-- replace

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle("Admission Fee Receipt - Ajit Sir’s Physics Tutorials");
}

function generateReceipt(rollNo) {
  try {
    if (!rollNo) return { error: "Please enter a Roll Number." };

    // Open Sheet
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Admissions");
    if (!sheet) return { error: "Sheet 'Admissions' not found." };

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rollIndex = headers.indexOf("RollNo");
    if (rollIndex === -1) return { error: "Header 'RollNo' missing." };

    // Find matching record
    let record = null;
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][rollIndex]).trim() === String(rollNo).trim()) {
        record = data[i];
        break;
      }
    }
    if (!record) return { error: "Roll Number not found in sheet." };

    // Extract details
    const name = record[headers.indexOf("Name")];
    const course = record[headers.indexOf("Course")];
    const payMode = record[headers.indexOf("PaymentMode")];
    const amount = record[headers.indexOf("Amount")];
    const installment = record[headers.indexOf("Installment")];
    const dueDate = record[headers.indexOf("DueDate")];
    const dateTime = record[headers.indexOf("DateTimeStamp")] || new Date().toLocaleString("en-IN");

    // Copy template
    const template = DriveApp.getFileById(TEMPLATE_DOC_ID);
    const copy = template.makeCopy(`FeeReceipt_${rollNo}_${name}`);
    const doc = DocumentApp.openById(copy.getId());
    const body = doc.getBody();

    // Replace placeholders
    body.replaceText("{{RollNo}}", rollNo);
    body.replaceText("{{Name}}", name);
    body.replaceText("{{Course}}", course);
    body.replaceText("{{PaymentMode}}", payMode);
    body.replaceText("{{Amount}}", amount);
    body.replaceText("{{Installment}}", installment);
    body.replaceText("{{DueDate}}", dueDate);
    body.replaceText("{{DateTimeStamp}}", dateTime);

    doc.saveAndClose();

    // Convert to PDF
    const pdfBlob = copy.getAs('application/pdf');
    const pdfData = Utilities.base64Encode(pdfBlob.getBytes());
    const pdfName = `FeeReceipt_${rollNo}.pdf`;

    // Save PDF in Drive (optional)
    DriveApp.createFile(pdfBlob).setName(pdfName);
    DriveApp.getFileById(copy.getId()).setTrashed(true);

    // Send back to browser
    return { pdfData: pdfData, filename: pdfName, message: "✅ Receipt generated successfully!" };

  } catch (err) {
    return { error: "⚠️ Error: " + err.message };
  }
}
